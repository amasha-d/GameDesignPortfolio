---
import { existsSync, readdirSync } from "node:fs";
import { extname, join } from "node:path";

const allowedExts = new Set([
".jpg",
".jpeg",
".png",
".gif",
".webp",
".avif",
]);
const base = import.meta.env.BASE_URL;
const artworksDir = join(process.cwd(), "public", "img", "artworks");
const featuredDir = join(artworksDir, "featured");
const tabOrder = [
"Paintings",
"Character Art",
"Graphics",
"Illustrations",
"Commissions",
"Fun",
];
const bodyBgStyle =
"background-color:#f6f4ee;" +
`background-image:url('${base}img/obj/floral-bg.png');` +
"background-repeat:repeat;" +
"background-size:800px auto;" +
"background-position:center;";

type ArtworkItem = {
src: string;
alt: string;
category: string;
sortKey: string;
};

function categoryFromFolder(folderName: string): string | null {
const key = folderName.toLowerCase().replace(/[-_]/g, " ").trim();
if (key === "paintings") return "Paintings";
if (key === "character art") return "Character Art";
if (key === "graphics") return "Graphics";
if (key === "illustrations") return "Illustrations";
if (key === "commissions") return "Commissions";
if (key === "fun") return "Fun";
return null;
}

function listArtworkFiles(
dir: string,
folderCategory: string | null = null,
): ArtworkItem[] {
const entries = readdirSync(dir, { withFileTypes: true });
const items: ArtworkItem[] = [];

for (const entry of entries) {
const fullPath = join(dir, entry.name);
if (entry.isDirectory()) {
if (entry.name.toLowerCase() === "featured") {
continue;
}

const nextCategory = categoryFromFolder(entry.name) ?? folderCategory;
items.push(...listArtworkFiles(fullPath, nextCategory));
continue;
}

const ext = extname(entry.name).toLowerCase();
if (!allowedExts.has(ext) || !folderCategory) continue;

const relPath = fullPath
.replace(join(process.cwd(), "public"), "")
.replaceAll("\\", "/")
.replace(/^\/+/, "");

items.push({
src: `${base}${encodeURI(relPath)}`,
alt: entry.name.replace(/\.[^/.]+$/, ""),
category: folderCategory,
sortKey: `${folderCategory}-${entry.name.toLowerCase()}`,
});
}

return items;
}

function listFeaturedFiles(dir: string): ArtworkItem[] {
const entries = readdirSync(dir, { withFileTypes: true });
const items: ArtworkItem[] = [];

for (const entry of entries) {
if (!entry.isFile()) continue;
const ext = extname(entry.name).toLowerCase();
if (!allowedExts.has(ext)) continue;

const fullPath = join(dir, entry.name);
const relPath = fullPath
.replace(join(process.cwd(), "public"), "")
.replaceAll("\\", "/")
.replace(/^\/+/, "");

items.push({
src: `${base}${encodeURI(relPath)}`,
alt: entry.name.replace(/\.[^/.]+$/, ""),
category: "Featured",
sortKey: entry.name.toLowerCase(),
});
}

return items.sort((a, b) =>
a.sortKey.localeCompare(b.sortKey, undefined, {
numeric: true,
sensitivity: "base",
}),
);
}

const artworks = listArtworkFiles(artworksDir)
.sort((a, b) =>
a.sortKey.localeCompare(b.sortKey, undefined, {
numeric: true,
sensitivity: "base",
}),
)
.map(({ sortKey, ...rest }) => rest);

const featured = (existsSync(featuredDir)
? listFeaturedFiles(featuredDir)
: artworks.map((art) => ({ ...art, sortKey: art.alt.toLowerCase() })))
.slice(0, 7)
.map(({ sortKey, ...rest }) => rest);
---

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Art Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&family=Nunito:wght@500;700&display=swap"
        rel="stylesheet" />
    <style>
        :root {
            --bg: #0f0f11;
            --font: #fff;
            --muted: #cfcfcf;
            --chip: #202127;
            --chip-active: #f0e4bf;
            --chip-active-text: #1c1d21;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            min-height: 100%;
            font-family: "Nunito", system-ui, Arial, sans-serif;
            color: var(--font);
        }

        .back-btn {
            position: fixed;
            left: 12px;
            top: 12px;
            z-index: 1200;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.92);
            color: #1a1a1a;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
            font-family: "Schoolbell", cursive;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #gallery {
            /* padding: 76px 24px 40px; */
            max-width: 1500px;
            margin: 0 auto;
        }

        .hero {
            width: 100vw;
            margin-left: calc(50% - 50vw);
            margin-right: calc(50% - 50vw);
            margin-bottom: 24px;
            position: relative;
        }

        .hero-stage {
            position: relative;
            width: 100%;
            min-height: clamp(260px, 44vw, 520px);
            height: clamp(260px, 44vw, 520px);
            overflow: hidden;
            background: #15161a;
        }

        .hero-stage::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg,
                    rgba(0, 0, 0, 0.28) 0%,
                    rgba(0, 0, 0, 0.42) 58%,
                    rgba(0, 0, 0, 0.58) 100%);
            z-index: 2;
            pointer-events: none;
        }

        .hero-slide {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .hero-slide.active {
            opacity: 1;
        }

        .hero-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .hero-title {
            position: absolute;
            left: 50%;
            bottom: clamp(16px, 4vw, 34px);
            transform: translateX(-50%);
            margin: 0;
            z-index: 3;
            font-family: "Schoolbell", cursive;
            font-size: clamp(2.4rem, 9vw, 6rem);
            line-height: 0.95;
            letter-spacing: 0.01em;
            color: #fff;
            text-shadow: 0 4px 18px rgba(0, 0, 0, 0.65);
            text-align: center;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 0 0 18px;
        }

        .tab-btn {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            background: var(--chip);
            color: #f3f3f3;
            padding: 8px 14px;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--chip-active);
            color: var(--chip-active-text);
            border-color: rgba(0, 0, 0, 0.18);
            font-weight: 700;
        }

        #image-gallery {
            display: block;
            column-count: 4;
            column-gap: 14px;
        }

        .image {
            display: inline-block;
            width: 100%;
            margin: 0 0 14px;
            break-inside: avoid;
            -webkit-column-break-inside: avoid;
        }

        .image.is-hidden {
            display: none;
        }

        .img-wrapper {
            position: relative;
            width: 100%;
            height: auto;
            overflow: hidden;
            border-radius: 12px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .img-wrapper img {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
            cursor: pointer;
        }

        .img-overlay {
            background: rgba(0, 0, 0, 0.7);
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease;
            cursor: pointer;
        }

        .img-overlay::after {
            content: "+";
            color: #fff;
            font-size: 4rem;
            font-weight: 300;
        }

        .img-wrapper:hover .img-overlay {
            opacity: 1;
        }

        #overlay {
            display: none;
            background: rgba(0, 0, 0, 0.88);
            position: fixed;
            inset: 0;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #overlay.show {
            display: flex;
        }

        #overlay img {
            max-width: 90%;
            max-height: 72vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
            display: none;
        }

        #overlay img.active {
            display: block;
        }

        #nextButton,
        #prevButton {
            color: #fff;
            font-size: 3.3rem;
            font-weight: 300;
            cursor: pointer;
            padding: 8px 20px;
            transition: opacity 0.3s ease;
            user-select: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            line-height: 1;
        }

        #nextButton:hover,
        #prevButton:hover,
        #exitButton:hover {
            opacity: 0.6;
        }

        #prevButton {
            left: 20px;
        }

        #nextButton {
            right: 20px;
        }

        #exitButton {
            color: #fff;
            font-size: 2.4rem;
            cursor: pointer;
            position: absolute;
            top: 16px;
            right: 22px;
            line-height: 1;
        }

        @media (max-width: 980px) {
            #image-gallery {
                column-count: 3;
            }
        }

        @media (max-width: 760px) {
            #gallery {
                /* padding-left: 70px; */
                padding-right: 24px;
                padding-left: 24px;
            }

            #nextButton,
            #prevButton {
                font-size: 2.2rem;
            }

            #exitButton {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body style={bodyBgStyle}>
    <a href={base} class="back-btn" aria-label="Go back"
        onclick="if(history.length>1){event.preventDefault();history.back();}">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round"></path>
        </svg>
        Back
    </a>

    <section id="gallery">
        <section class="hero" aria-label="Featured artworks">
            <div class="hero-stage" id="heroStage">
                {
                featured.map((art, idx) => (
                <div class={`hero-slide ${idx===0 ? "active" : "" }`}>
                    <img src={art.src} alt={art.alt} loading={idx < 2 ? "eager" : "lazy" } />
                </div>
                ))
                }
                <h1 class="hero-title">Artworks</h1>
            </div>
        </section>

        <nav class="tabs" aria-label="Artwork categories">
            {
            tabOrder.map((tab, idx) => (
            <button class={`tab-btn ${idx===0 ? "active" : "" }`} type="button" data-filter={tab}>
                {tab}
            </button>
            ))
            }
        </nav>

        <div id="image-gallery">
            {
            artworks.map((art) => (
            <div class="image" data-category={art.category}>
                <div class="img-wrapper">
                    <img src={art.src} alt={art.alt} loading="lazy" />
                    <div class="img-overlay"></div>
                </div>
            </div>
            ))
            }
        </div>
    </section>

    <div id="overlay">
        <div id="prevButton">&lsaquo;</div>
        <img alt="" />
        <div id="nextButton">&rsaquo;</div>
        <div id="exitButton">&times;</div>
    </div>

    <script>
        const allCards = Array.from(
            document.querySelectorAll("#image-gallery .image"),
        );
        const allImages = Array.from(
            document.querySelectorAll("#image-gallery img"),
        );
        const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
        const overlay = document.getElementById("overlay");
        const overlayImg = overlay.querySelector("img");
        const prevBtn = document.getElementById("prevButton");
        const nextBtn = document.getElementById("nextButton");
        const exitBtn = document.getElementById("exitButton");

        let currentIndex = 0;
        let activeImages = allImages;

        const heroSlides = Array.from(document.querySelectorAll(".hero-slide"));
        let heroIndex = 0;
        if (heroSlides.length > 1) {
            setInterval(() => {
                heroSlides[heroIndex].classList.remove("active");
                heroIndex = (heroIndex + 1) % heroSlides.length;
                heroSlides[heroIndex].classList.add("active");
            }, 2600);
        }

        function syncActiveImages() {
            activeImages = allCards
                .filter((card) => !card.classList.contains("is-hidden"))
                .map((card) => card.querySelector("img"))
                .filter(Boolean);
        }

        function showImage(idx) {
            if (!activeImages.length) return;
            overlayImg.classList.remove("active");
            setTimeout(() => {
                overlayImg.src = activeImages[idx].src;
                overlayImg.alt = activeImages[idx].alt;
                overlayImg.classList.add("active");
            }, 80);
        }

        function applyFilter(filter) {
            allCards.forEach((card) => {
                const category = card.dataset.category || "Illustrations";
                const visible = category === filter;
                card.classList.toggle("is-hidden", !visible);
            });

            syncActiveImages();
            if (overlay.classList.contains("show")) {
                overlay.classList.remove("show");
                overlayImg.classList.remove("active");
            }
        }

        tabButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                tabButtons.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                const filter = btn.dataset.filter || "Illustrations";
                applyFilter(filter);
            });
        });

        const initialActive = document.querySelector(".tab-btn.active");
        if (initialActive instanceof HTMLButtonElement) {
            applyFilter(initialActive.dataset.filter || "Illustrations");
        }

        allImages.forEach((img) => {
            img.addEventListener("click", () => {
                syncActiveImages();
                currentIndex = activeImages.indexOf(img);
                if (currentIndex < 0) return;
                overlayImg.src = img.src;
                overlayImg.alt = img.alt;
                overlayImg.classList.add("active");
                overlay.classList.add("show");
            });
        });

        document
            .querySelectorAll("#image-gallery .img-overlay")
            .forEach((overlayEl, idx) => {
                overlayEl.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const img = allImages[idx];
                    if (!img) return;
                    syncActiveImages();
                    currentIndex = activeImages.indexOf(img);
                    if (currentIndex < 0) return;
                    overlayImg.src = img.src;
                    overlayImg.alt = img.alt;
                    overlayImg.classList.add("active");
                    overlay.classList.add("show");
                });
            });

        prevBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!activeImages.length) return;
            currentIndex =
                (currentIndex - 1 + activeImages.length) % activeImages.length;
            showImage(currentIndex);
        });

        nextBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!activeImages.length) return;
            currentIndex = (currentIndex + 1) % activeImages.length;
            showImage(currentIndex);
        });

        exitBtn.addEventListener("click", () => {
            overlayImg.classList.remove("active");
            overlay.classList.remove("show");
        });

        overlay.addEventListener("click", () => {
            overlayImg.classList.remove("active");
            overlay.classList.remove("show");
        });

        document.addEventListener("keydown", (e) => {
            if (!overlay.classList.contains("show")) return;
            if (e.key === "ArrowLeft") {
                currentIndex =
                    (currentIndex - 1 + activeImages.length) % activeImages.length;
                showImage(currentIndex);
            } else if (e.key === "ArrowRight") {
                currentIndex = (currentIndex + 1) % activeImages.length;
                showImage(currentIndex);
            } else if (e.key === "Escape") {
                overlayImg.classList.remove("active");
                overlay.classList.remove("show");
            }
        });
    </script>
</body>

</html>
